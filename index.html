<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Extract and analyze Rohan's timesheet data from PDF files">
    <meta name="author" content="Timesheet Parser">
    <title>Rohan's Timesheet Parser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <style>
        /* ... (All previous CSS styles remain unchanged) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        }

        .upload-area:hover {
            border-color: #4facfe;
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #00f2fe;
            background: linear-gradient(145deg, #e0f2f1, #b2dfdb);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #4facfe;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
            width: 0%;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results-header {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .summary {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .export-buttons {
            margin-top: 20px;
            text-align: center;
        }

        .export-buttons button {
            margin: 0 10px;
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
        }

        .timesheet-selector {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
        }

        .timesheet-selector h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .selector-controls select {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        .selector-controls select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .notes-section {
            margin-top: 15px;
        }

        .notes-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s ease;
        }

        .notes-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .notes-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .delete-btn {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #721c24;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);
        }

        .saved-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .error {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .debug-toggle {
            text-align: center;
            margin-bottom: 20px;
        }
        #debugInfo {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
        }
        #debugInfo h3 {
            color: #1abc9c;
            border-bottom: 1px solid #34495e;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        #debugInfo pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
        }

        @media (max-width: 600px) {
            .content { padding: 20px; }
            .header h1 { font-size: 2rem; }
            .upload-area { padding: 40px 15px; }
            .data-table { font-size: 0.9rem; }
            .data-table th, .data-table td { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Rohan's Timesheet Parser</h1>
            <p>Extract and analyze Rohan's timesheet data from PDF files</p>
        </div>

        <div class="content">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">📄</div>
                <div class="upload-text">Click to select PDF file or drag and drop</div>
                <button class="btn">Choose File</button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf" />
            </div>

            <div class="debug-toggle">
                <label>
                    <input type="checkbox" id="debugModeToggle"> Enable Debug Mode
                </label>
            </div>

            <div class="progress">
                <div class="progress-bar"></div>
            </div>
            <div class="error" id="error"></div>
            <div class="timesheet-selector" id="timesheetSelector">
                 <h3>📂 Saved Timesheets <span class="saved-count" id="savedCount">0 saved</span></h3>
                <div class="selector-controls">
                    <select id="timesheetSelect">
                        <option value="">Select a timesheet...</option>
                    </select>
                    <button class="delete-btn" onclick="deleteSelectedTimesheet()" id="deleteBtn" style="display: none;">🗑️ Delete</button>
                </div>
                <div class="notes-section">
                    <label class="notes-label" for="notesInput">📝 Area/Location Notes:</label>
                    <textarea id="notesInput" class="notes-input" placeholder="e.g., ATM maintenance, Office work, Field service..."></textarea>
                </div>
            </div>

            <div class="results" id="results">
                <div class="results-header">
                    <h2>📋 Extracted Data</h2>
                    <p id="fileName"></p>
                </div>
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Start Time</th>
                            <th>Area/Location</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="summary">
                     <h3>📈 Summary</h3>
                    <div class="summary-item">
                        <span>Total Shifts:</span>
                        <span id="totalShifts">0</span>
                    </div>
                    <div class="summary-item">
                        <span>Total Entries Found:</span>
                        <span id="totalEntries">0</span>
                    </div>
                </div>
                <div class="export-buttons">
                    <button class="btn" onclick="exportToCSV()">💾 Export CSV</button>
                    <button class="btn" onclick="exportToJSON()">📄 Export JSON</button>
                    <button class="btn" onclick="saveTimesheet()">💾 Save Timesheet</button>
                </div>
            </div>

            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        let extractedData = [];
        let currentTimesheetId = null;
        let savedTimesheets = {};
        let debugMode = false;
        
        window.onload = function() {
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            } catch (e) {
                console.error("PDF.js library failed to load or set up.", e);
                showError("Critical Error: Could not initialize PDF library. Please refresh.");
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadSavedTimesheets();
            document.getElementById('debugModeToggle').addEventListener('change', (e) => {
                debugMode = e.target.checked;
                const debugPanel = document.getElementById('debugInfo');
                if (!debugMode) {
                    debugPanel.style.display = 'none';
                    debugPanel.innerHTML = '';
                }
            });
        });
        
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.querySelector('.upload-area');
        const progress = document.querySelector('.progress');
        const progressBar = document.querySelector('.progress-bar');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const debugPanel = document.getElementById('debugInfo');

        fileInput.addEventListener('change', handleFileSelect);
        document.getElementById('timesheetSelect').addEventListener('change', handleTimesheetSelect);
        document.getElementById('notesInput').addEventListener('input', updateCurrentTimesheetNotes);

        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) processPDF(files[0]);
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processPDF(file);
        }

        async function processPDF(file) {
            if (file.type !== 'application/pdf') {
                showError('Please select a PDF file.');
                return;
            }
            if (typeof pdfjsLib === 'undefined' || !pdfjsLib.getDocument) {
                showError('PDF library is not loaded. Please wait a moment and try again, or refresh the page.');
                return;
            }
            hideError();
            showProgress();
            results.style.display = 'none';
            debugPanel.style.display = 'none';
            debugPanel.innerHTML = '';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let allItems = [];
                for (let i = 1; i <= pdf.numPages; i++) {
                    updateProgress((i / pdf.numPages) * 50);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    allItems.push(...textContent.items);
                }
                updateProgress(75);
                const { entries, debugData } = parseTimesheetData(allItems);
                extractedData = entries;
                updateProgress(100);
                displayResults(file.name, extractedData);
                if (debugMode) displayDebugInfo(debugData);
                hideProgress();
                currentTimesheetId = null;
                document.getElementById('timesheetSelect').value = '';
                document.getElementById('notesInput').value = '';
                document.getElementById('deleteBtn').style.display = 'none';
            } catch (err) {
                console.error('Error processing PDF:', err);
                showError('Error processing PDF file. Please try again.');
                hideProgress();
            }
        }
        
        // =================================================================
        // ===== START OF FINAL, CORRECTED FUNCTION ========================
        // =================================================================
        function parseTimesheetData(items) {
            const timePattern = /(\d{1,2}:\d{2})-\d{1,2}:\d{2}/;
            const detailedLog = [];

            // 1. Identify all unique X and Y coordinates to define grid lines
            const xCoords = new Set();
            const yCoords = new Set();
            items.forEach(item => {
                xCoords.add(Math.round(item.transform[4])); // Round to group close items
                yCoords.add(Math.round(item.transform[5]));
            });

            const sortedX = Array.from(xCoords).sort((a, b) => a - b);
            const sortedY = Array.from(yCoords).sort((a, b) => a - b);

            // 2. Create and populate the virtual grid
            const grid = Array(sortedY.length).fill(null).map(() => Array(sortedX.length).fill(''));
            items.forEach(item => {
                const xIndex = sortedX.indexOf(Math.round(item.transform[4]));
                const yIndex = sortedY.indexOf(Math.round(item.transform[5]));
                if (xIndex > -1 && yIndex > -1) {
                    grid[yIndex][xIndex] += (grid[yIndex][xIndex] ? ' ' : '') + item.str;
                }
            });

            // 3. Find column index for each day
            const dayColumns = {};
            const dayHeaders = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            grid.forEach(row => {
                row.forEach((cell, colIndex) => {
                    if (dayHeaders.includes(cell.trim())) {
                        dayColumns[cell.trim()] = colIndex;
                    }
                });
            });

            // 4. Parse the grid to find Rohan's shifts
            const rohanEntries = [];
            grid.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    if (cell.toLowerCase().startsWith('rohan')) {
                        const day = Object.keys(dayColumns).find(d => dayColumns[d] === colIndex) || 'Unknown';
                        let time = '';
                        let section = '';

                        // Look up for the time
                        for (let r = rowIndex; r >= 0; r--) {
                            const potentialTime = grid[r][colIndex].trim();
                            if (timePattern.test(potentialTime)) {
                                time = potentialTime.match(timePattern)[1];
                                break;
                            }
                        }

                        // Look left for the section
                        for (let c = colIndex; c >= 0; c--) {
                             const potentialSection = grid[rowIndex][c];
                             if (potentialSection && isNaN(potentialSection.charAt(0))) {
                                section = potentialSection;
                                break;
                             }
                        }
                        
                        if (day !== 'Unknown' && time) {
                            rohanEntries.push({
                                day: day,
                                startTime: time,
                                location: section,
                                notes: cell.toLowerCase().includes('(atm)') ? 'ATM duties' : 'Regular duties'
                            });
                            detailedLog.push(`Found Rohan in [Row ${rowIndex}, Col ${colIndex}]. Day: ${day}, Time: ${time}, Section: ${section}`);
                        }
                    }
                });
            });
            
            // 5. Deduplicate and sort
            const uniqueEntries = Array.from(new Map(rohanEntries.map(entry => [`${entry.day}`, entry])).values());
            const dayOrder = { 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5 };
            uniqueEntries.sort((a, b) => dayOrder[a.day] - dayOrder[b.day]);

            return {
                entries: uniqueEntries,
                debugData: { grid, dayColumns, detailedLog }
            };
        }
        // =================================================================
        // ===== END OF FINAL, CORRECTED FUNCTION ==========================
        // =================================================================
        
        function displayDebugInfo(debugData) {
            const { grid, dayColumns, detailedLog } = debugData;
            let html = '<h3>⚙️ Debug Information</h3>';
            html += '<h4>Detected Day Columns (Column Index)</h4>';
            html += `<pre>${JSON.stringify(dayColumns, null, 2)}</pre>`;
            html += '<h4>Processing Log</h4>';
            html += `<pre>${detailedLog.join('\n')}</pre>`;
            // Optional: Display the full grid (can be very large)
            // html += '<h4>Reconstructed Grid</h4>';
            // html += `<pre>${grid.map(row => row.join('\t|\t')).join('\n')}</pre>`;
            debugPanel.innerHTML = html;
            debugPanel.style.display = 'block';
        }

        function displayResults(fileName, data) {
            document.getElementById('fileName').textContent = `File: ${fileName} (Rohan's Start Times)`;
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="4" style="text-align: center; color: #666; font-style: italic;">No start times found for Rohan in this roster</td>`;
            } else {
                data.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td><strong>${entry.day}</strong></td><td><strong>${entry.startTime}</strong></td><td>${entry.location}</td><td>${entry.notes}</td>`;
                });
            }
            document.getElementById('totalShifts').textContent = data.length;
            document.getElementById('totalEntries').textContent = data.length;
            results.style.display = 'block';
        }
        
        // --- All helper functions (export, save, etc.) are unchanged ---
        function loadSavedTimesheets() { /* ... */ }
        function updateTimesheetSelector() { /* ... */ }
        function handleTimesheetSelect(e) { /* ... */ }
        function updateCurrentTimesheetNotes() { /* ... */ }
        function exportToCSV() { /* ... */ }
        function exportToJSON() { /* ... */ }
        function downloadFile(content, filename, mimeType) { /* ... */ }
        function saveTimesheet() { /* ... */ }
        function deleteSelectedTimesheet() { /* ... */ }
        function showProgress(){ progress.style.display = 'block'; }
        function hideProgress(){ progress.style.display = 'none'; progressBar.style.width = '0%'; }
        function updateProgress(percent){ progressBar.style.width = percent + '%'; }
        function showError(message){ error.textContent = message; error.style.display = 'block'; }
        function hideError(){ error.style.display = 'none'; }
    </script>
</body>
</html>
